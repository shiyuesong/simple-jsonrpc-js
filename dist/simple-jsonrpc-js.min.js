!function(e){"use strict";var r=Promise;if(void 0===r&&(r=e.Promise),void 0===r)throw"Promise is not supported! Use latest version node/browser or promise-polyfill";var n=function(e){return void 0===e},t=Array.isArray,o=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)},s=function(e){return"function"==typeof e},a=function(e){return"string"==typeof e},i=function(e){if(o(e)){for(var r in e)if(e.hasOwnProperty(r))return!1;return!0}return t(e)?!e.length:!e},u=function(e,r){if(t(e))return e.map(r);for(var n in e)e.hasOwnProperty(n)&&r(e[n])},c=function(e){return JSON.parse(JSON.stringify(e))},f={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};function d(e,r,n){this.message=r||"",this.code=e||-32e3,Boolean(n)&&(this.data=n)}d.prototype=new Error;var p=function(){var e=this,p={},m=0,l={};function h(e,r){var n=c(e);return r&&(o(r)&&r.hasOwnProperty("message")?n.data=r.message:a(r)&&(n.data=r),r instanceof d&&(n={message:r.message,code:r.code},r.hasOwnProperty("data")&&(n.data=r.data))),n}function v(e){try{return function(e){return!!e.error}(e)?(a=e,void(p.hasOwnProperty(a.id)?p[a.id].reject(a.error):console.log("Unknown request",a))):function(e){return e.hasOwnProperty("result")&&e.hasOwnProperty("id")}(e)?(s=e,void(p.hasOwnProperty(s.id)?(p[s.id].resolve(s.result),delete p[s.id]):console.log("unknown request",s))):function(e){return!!e.method}(e)?function(e){if(!l.hasOwnProperty(e.method))return r.resolve({jsonrpc:"2.0",id:e.id,error:h(f.METHOD_NOT_FOUND,{message:e.method})});try{var s;if(e.hasOwnProperty("params")){if("pass"==l[e.method].params)s=l[e.method].fn.call(l,e.params);else if(t(e.params))s=l[e.method].fn.apply(l,e.params);else if(o(e.params)){if(!(l[e.method].params instanceof Array))return r.resolve({jsonrpc:"2.0",id:e.id,error:h(f.INVALID_PARAMS,"Undeclared arguments of the method "+e.method)});var a=[];if(l[e.method].params.forEach(function(r){e.params.hasOwnProperty(r)?(a.push(e.params[r]),delete e.params[r]):a.push(void 0)}),Object.keys(e.params).length>0)return r.resolve({jsonrpc:"2.0",id:e.id,error:h(f.INVALID_PARAMS,{message:"Params: "+Object.keys(e.params).toString()+" not used"})});s=l[e.method].fn.apply(l,a)}}else s=l[e.method].fn();return e.hasOwnProperty("id")?(i=s)&&"function"==typeof i.then?s.then(function(r){return n(r)&&(r=!0),{jsonrpc:"2.0",id:e.id,result:r}}).catch(function(r){return{jsonrpc:"2.0",id:e.id,error:h(f.INTERNAL_ERROR,r)}}):(n(s)&&(s=!0),r.resolve({jsonrpc:"2.0",id:e.id,result:s})):r.resolve()}catch(n){return r.resolve({jsonrpc:"2.0",id:e.id,error:h(f.INTERNAL_ERROR,n)})}var i}(e):r.resolve({id:null,jsonrpc:"2.0",error:h(f.INVALID_REQUEST)})}catch(e){return console.error("Resolver error:"+e.message,e),r.reject(e)}var s,a}function g(e,r){var n={jsonrpc:"2.0",method:e,params:r};return!o(r)&&!a(r)||i(r)||(n.params=r),n}function y(e,n){var t={jsonrpc:"2.0",method:e,id:m+=1};return!o(n)&&!a(n)||i(n)||(t.params=n),{promise:new r(function(e,r){p[m.toString()]={resolve:e,reject:r}}),message:t}}e.toStream=function(e){console.log("Need define the toStream method before use"),console.log(arguments)},e.dispatch=function(e,r,o){if(a(e)&&"pass"==r&&s(o))l[e]={fn:o,params:r};else if(a(e)&&t(r)&&s(o))l[e]={fn:o,params:r};else{if(!(a(e)&&s(r)&&n(o)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");l[e]={fn:r,params:null}}},e.on=e.dispatch,e.off=function(e){delete l[e]},e.call=function(r,n){var t=y(r,n);return e.toStream(JSON.stringify(t.message)),t.promise},e.notification=function(r,n){e.toStream(JSON.stringify(g(r,n)))},e.batch=function(n){var t=[],o=[];return u(n,function(e){if(e.hasOwnProperty("call")){var r=y(e.call.method,e.call.params);o.push(r.message),t.push(r.promise.then(function(e){return e},function(e){return e}))}else e.hasOwnProperty("notification")&&o.push(g(e.notification.method,e.notification.params))}),e.toStream(JSON.stringify(o)),r.all(t)},e.messageHandler=function(s){try{return function(s){var a=[];return t(s)?u(s,function(e){a.push(v(e))}):o(s)&&a.push(v(s)),r.all(a).then(function(r){var t=[];return u(r,function(e){n(e)||t.push(e)}),1===t.length?e.toStream(JSON.stringify(t[0])):t.length>1&&e.toStream(JSON.stringify(t)),r})}(JSON.parse(s))}catch(n){return console.log("Error in messageHandler(): ",n),e.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:f.PARSE_ERROR})),r.reject(n)}},e.customException=function(e,r,n){return new d(e,r,n)}};if("function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return p});else if("undefined"!=typeof module&&void 0!==module.exports)module.exports=p;else{if(void 0===e)return p;e.simple_jsonrpc=p}}(this);